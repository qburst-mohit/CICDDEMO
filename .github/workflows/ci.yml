name: CI - Android APK

on:
  push:
    branches:
      - develop
      - main

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
      # ---------- Checkout ----------
      - name: Checkout source code
        uses: actions/checkout@v4

      # ---------- Init Metrics File ----------
      - name: Initialize CI metrics file
        run: echo "CI METRICS REPORT" > ci-metrics.txt

      # ---------- Setup ----------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Java (JDK 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # ---------- Dependencies ----------
      - name: Install npm dependencies
        run: npm install

      # ---------- Test Metrics ----------
      - name: Run unit tests and capture report
        run: |
          echo "TEST_EXECUTION_START=$(date +%s)" | tee -a ci-metrics.txt
          npm test -- --ci --runInBand --verbose | tee test-output.log
          echo "TEST_EXECUTION_END=$(date +%s)" | tee -a ci-metrics.txt

      - name: Mark test success
        if: success()
        run: echo "TEST_STATUS=SUCCESS" | tee -a ci-metrics.txt

      - name: Mark test failure
        if: failure()
        run: echo "TEST_STATUS=FAILED" | tee -a ci-metrics.txt

      # ---------- Cache ----------
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}

      # ---------- Build Duration ----------
      - name: Record build start time
        run: echo "BUILD_START=$(date +%s)" >> $GITHUB_ENV

      - name: Build Debug APK with timing
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug
          BUILD_END=$(date +%s)
          echo "BUILD_DURATION_SECONDS=$((BUILD_END - BUILD_START))" | tee -a ../ci-metrics.txt

      # ---------- Build Success Rate ----------
      - name: Mark build success
        if: success()
        run: echo "BUILD_STATUS=SUCCESS" | tee -a ci-metrics.txt

      - name: Mark build failure
        if: failure()
        run: echo "BUILD_STATUS=FAILED" | tee -a ci-metrics.txt

      # ---------- Resource Utilization ----------
      - name: Capture runner resource information
        run: |
          echo "RUNNER_OS=$RUNNER_OS" | tee -a ci-metrics.txt
          echo "CPU_CORES=$(nproc)" | tee -a ci-metrics.txt
          echo "MEMORY_INFO:" | tee -a ci-metrics.txt
          free -h | tee -a ci-metrics.txt

      # ---------- Upload APK ----------
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk

      # ---------- Upload CI Metrics ----------
      - name: Upload CI metrics artifact
        uses: actions/upload-artifact@v4
        with:
          name: ci-metrics
          path: |
            ci-metrics.txt
            test-output.log

  # ---------- Deployment Metrics Job ----------
  deploy-production:
    runs-on: ubuntu-latest
    needs: build-apk
    environment: production

    steps:
      # ---------- Init Metrics File ----------
      - name: Initialize deployment metrics file
        run: echo "DEPLOYMENT METRICS REPORT" > deploy-metrics.txt

      # ---------- Deployment Duration ----------
      - name: Record deployment start time
        run: echo "DEPLOY_START=$(date +%s)" >> $GITHUB_ENV

      - name: Deploy to production
        run: echo "DEPLOYMENT_COMPLETED"

      - name: Record deployment end time
        run: |
          DEPLOY_END=$(date +%s)
          echo "DEPLOYMENT_DURATION_SECONDS=$((DEPLOY_END - DEPLOY_START))" | tee -a deploy-metrics.txt

      # ---------- Lead Time ----------
      - name: Capture commit timestamp
        run: echo "COMMIT_TIME=$(git show -s --format=%ct $GITHUB_SHA)" >> $GITHUB_ENV

      - name: Calculate lead time for changes
        run: |
          NOW=$(date +%s)
          echo "LEAD_TIME_SECONDS=$((NOW - COMMIT_TIME))" | tee -a deploy-metrics.txt

      # ---------- MTTR ----------
      - name: Capture deployment failure time
        if: failure()
        run: echo "FAILURE_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: Calculate MTTR
        if: success()
        run: |
          RECOVERY_TIME=$(date +%s)
          if [ -n "$FAILURE_TIME" ]; then
            echo "MTTR_SECONDS=$((RECOVERY_TIME - FAILURE_TIME))" | tee -a deploy-metrics.txt
          fi

      # ---------- Upload Deployment Metrics ----------
      - name: Upload deployment metrics artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-metrics
          path: deploy-metrics.txt
